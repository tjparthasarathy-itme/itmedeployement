const { generateEmailContent, sendEmail } = require("./server.js");
function validateContactNumber(contactNumber) {
  return /^\d{10}$/.test(contactNumber);
}

function validateEmail(email) {
  // This is a simple regex for basic email validation
  return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email);
}

function openPopup(message) {
  document.getElementById("popupContent").innerHTML = message;
  document.getElementById("popupModal").style.display = "block";
}

function closePopup() {
  document.getElementById("popupModal").style.display = "none";
}

function getCheckedCity() {
  var checkedCity = "";
  var checkboxes = document.querySelectorAll('input[name="places[]"]:checked');
  checkboxes.forEach(function (checkbox) {
    checkedCity += checkbox.value + ", ";
  });
  checkedCity = checkedCity.trim().slice(0, -1);
  return checkedCity;
}

function submit_Bookspace_Form() {
  const contactNumber = document.getElementById("mobile-number").value;
  const email = document.getElementById("email").value;

  const requiredFields = [
    "user-name",
    "designation",
    "company",
    "mobile-number",
    "email",
    "address",
    "city-state",
  ];

  for (const field of requiredFields) {
    const value = document.getElementById(field).value;
    if (value.trim() === "") {
      openPopup(`Please enter a value for ${field.replace("-", " ")}.`);
      return;
    }
  }

  if (!validateContactNumber(contactNumber)) {
    openPopup("Please enter a valid 10-digit contact number.");
    return;
  }

  if (!validateEmail(email)) {
    openPopup("Please enter a valid email address.");
    return;
  }

  const selectedCities = document.querySelectorAll(
    'input[name="places[]"]:checked'
  );

  if (selectedCities.length === 0) {
    openPopup("Please select at least one city.");
    return;
  }

  const formData = {
    "user-name": document.getElementById("user-name").value,
    designation: document.getElementById("designation").value,
    company: document.getElementById("company").value,
    "mobile-number": contactNumber,
    email: email,
    address: document.getElementById("address").value,
    "city-state": document.getElementById("city-state").value,
    bookingType: "booking request for space in the exhibition ",
    places: Array.from(
      document.querySelectorAll('input[name="places[]"]:checked')
    ).map((checkbox) => checkbox.value),
  };

  formData.checkedCity = getCheckedCity();

  closePopup();
  fetch("/submit-booking", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify(formData),
  })
    .then((response) => handleFormSubmission(response, formData, "booking"))
    .catch((error) => {
      console.error("Error during form submission:", error);
    });
}

function submit_TradeVisitor_Form() {
  const contactNumber = document.getElementById("mobile-number").value;
  const email = document.getElementById("email").value;

  const requiredFields = [
    "user-name",
    "designation",
    "company",
    "mobile-number",
    "email",
    "address",
    "city-state",
  ];

  for (const field of requiredFields) {
    const value = document.getElementById(field).value;
    if (value.trim() === "") {
      openPopup(`Please enter a value for ${field.replace("-", " ")}.`);
      return;
    }
  }

  if (!validateContactNumber(contactNumber)) {
    openPopup("Please enter a valid 10-digit contact number.");
    return;
  }

  if (!validateEmail(email)) {
    openPopup("Please enter a valid email address.");
    return;
  }

  const selectedCities = document.querySelectorAll(
    'input[name="places[]"]:checked'
  );

  if (selectedCities.length === 0) {
    openPopup("Please select at least one city.");
    return;
  }
  const formData = {
    "user-name": document.getElementById("user-name").value,
    designation: document.getElementById("designation").value,
    company: document.getElementById("company").value,
    "mobile-number": contactNumber,
    email: email,
    address: document.getElementById("address").value,
    "city-state": document.getElementById("city-state").value,
    bookingType: "Registration for Trade visitor",
    places: Array.from(
      document.querySelectorAll('input[name="places[]"]:checked')
    ).map((checkbox) => checkbox.value),
  };

  formData.checkedCity = getCheckedCity();
  closePopup();
  fetch("/submit-booking", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify(formData),
  })
    .then((response) => handleFormSubmission(response, formData, "booking"))
    .catch((error) => {
      console.error("Error during form submission:", error);
    });
}

function submit_GenVisitor_Form() {
  const contactNumber = document.getElementById("mobile-number").value;
  const email = document.getElementById("email").value;

  const requiredFields = [
    "user-name",
    "designation",
    "company",
    "mobile-number",
    "email",
    "address",
    "city-state",
  ];

  for (const field of requiredFields) {
    const value = document.getElementById(field).value;
    if (value.trim() === "") {
      openPopup(`Please enter a value for ${field.replace("-", " ")}.`);
      return;
    }
  }

  if (!validateContactNumber(contactNumber)) {
    openPopup("Please enter a valid 10-digit contact number.");
    return;
  }

  if (!validateEmail(email)) {
    openPopup("Please enter a valid email address.");
    return;
  }

  const selectedCities = document.querySelectorAll(
    'input[name="places[]"]:checked'
  );

  if (selectedCities.length === 0) {
    openPopup("Please select at least one city.");
    return;
  }
  const formData = {
    "user-name": document.getElementById("user-name").value,
    designation: document.getElementById("designation").value,
    company: document.getElementById("company").value,
    "mobile-number": contactNumber,
    email: email,
    address: document.getElementById("address").value,
    "city-state": document.getElementById("city-state").value,
    bookingType: "Registration for General visitor",
    places: Array.from(
      document.querySelectorAll('input[name="places[]"]:checked')
    ).map((checkbox) => checkbox.value),
  };

  formData.checkedCity = getCheckedCity();
  closePopup();
  fetch("/submit-booking", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify(formData),
  })
    .then((response) => handleFormSubmission(response, formData, "booking"))
    .catch((error) => {
      console.error("Error during form submission:", error);
    });
}

function submit_contactUs_form(event) {
  event.preventDefault(); // Prevent the default form submission behavior
  const contactNumber = document.getElementById("phone").value;
  const email = document.getElementById("email_id").value;

  const requiredFields = [
    "firstname",
    "lastname",
    "phone",
    "email_id",
    "message",
  ];

  for (const field of requiredFields) {
    const value = document.getElementById(field).value;
    if (value.trim() === "") {
      openPopup(`Please enter a value for ${field.replace("_", " ")}.`);
      return;
    }
  }

  if (!validateContactNumber(contactNumber)) {
    openPopup("Please enter a valid 10-digit contact number.");
    return;
  }

  if (!validateEmail(email)) {
    openPopup("Please enter a valid email address.");
    return;
  }
  const contactUsformData = {
    firstname: document.getElementById("firstname").value,
    lastname: document.getElementById("lastname").value,
    email_id: email, // Correct the ID for the email field
    phone: contactNumber,
    message: document.getElementById("message").value,
  };
  closePopup();
  fetch("/contactUs", {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify(contactUsformData),
  })
    .then((response) =>
      handleFormSubmission(response, contactUsformData, "contactUs")
    )
    .catch((error) => {
      console.error("Error during form submission:", error);
    });
}

function handleFormSubmission(response, formData, formType) {
  if (formType === "booking") {
    if (response.ok) {
      openPopup(
        "Your form was successfully submitted. Our agent will contact you soon.",
        formData.checkedCity
      );
      document.getElementById("book-event").reset();
      setTimeout(function () {
        closePopup(); // Close the popup after a delay (adjust as needed)
        location.assign("/"); // Redirect to index.html after a delay
      }, 3000); // Adjust the delay as needed (3000 milliseconds = 3 seconds)
    } else {
      console.error("Form submission failed.");
    }
  } else {
    if (response.ok) {
      openPopup(
        "Your message was successfully submitted !!! You will hear from us soon"
      );
      document.getElementById("ajax_contact").reset();
      setTimeout(function () {
        closePopup(); // Close the popup after a delay (adjust as needed)
        location.assign("/"); // Redirect to index.html after a delay
      }, 3000); // Adjust the delay as needed (3000 milliseconds = 3 seconds)
    } else {
      console.error("Message submission failed.");
    }
  }
  const emailContent = generateEmailContent(formData, formType);
  sendEmail(emailContent);
}
